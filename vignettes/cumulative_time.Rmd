---
title: "Raster, cumulative probability, and cumulative time plot"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Cumulative Time}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction 

This notebook summarises the existing functions in gutbehaviour for descriptive analysis and visualisation of mice velocity data. 

# Data imports and preprocessing
```{r}
library(tidyverse)
library(gutbehaviour)
data <- read.csv("/Users/hephaescheun/Documents/gutbehaviour_data_confid/all_mice.csv") # data matrix here
average.velocity <- read.csv("/Users/hephaescheun/Documents/gutbehaviour_data_confid/all_mice_velocity.csv") # average velocity here 
P.DATA <- gutbehaviour::lm_preprocess(data, average.velocity)
```

# Generate event profiles and processing them
Event profiles contain all the information about the timings of each event for every subject. 
```{r, cache=TRUE} 
event_profiles <- gutbehaviour::EventProfiles_all(P.DATA, 14, 2, factor.freeze = 0.2, factor.flight = 3)
eventless_profile <- gutbehaviour::.EventlessProfile(event_profiles, P.DATA)
```

```{r, cache=TRUE}
event.prof <- event_profiles[[1]] %>% gutbehaviour::processed_eventprofiles()
processed_event_prof <- rbind(event_profiles[[1]], eventless_profile) %>% gutbehaviour::processed_eventprofiles()
```

# Generate raster plots and cumulative probability plots 
```{r, cache=TRUE}
cumuprob_plot_new <- gutbehaviour::cumuprob_plot(event_profiles[[1]], P.DATA$time_intervals)
raster <- gutbehaviour::various_lm_plots(processed_event_prof,time_intervals = P.DATA$time_intervals, size_parameter = 2)
```

```{r, fig.width=7, fig.height=7, out.width="700px", out.height="700px"}
raster + theme(
  axis.text.y = element_blank(),
  axis.ticks = element_blank(),
  plot.background = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  panel.border = element_blank(),
  axis.title.y.left = element_blank())
```

```{r, fig.width=7, fig.height=7, out.width="700px", out.height="700px"}
cumuprob_plot_new$plot
```

# Generate cumulative time plot 

`master_cumulative_prof` stores all the information about the cumulative times of events for every subject up to the time being considered. By default, the time points considered are generated by the following procedure: the time interval between the start and the end of the experiment are partitioned into a number of 0.1-second-long interval. If the total time elapsed in the experiment is 15 seconds, by default there are 150 time points being considered. 

```{r, cache=TRUE}
master_cumulative_prof <- gutbehaviour::generate_cumulative_profiles(P.DATA, processed_event_prof)
```

Since `master_cumulative_prof` contains all information about cumulative times, if we want to generate a plot for a particular event, we have to extract the relevant information by the following function:

```{r, cache = TRUE}
freezing_cumu <- gutbehaviour::generate_cumutime_per_event(master_cumulative_prof[[2]], event_considered = "freeze", P.DATA, master_cumulative_prof[[1]]) # change the event_considered variable to one of "freeze", "flight", "shelter", "eventless" to extract the relevant data
```

We have to pass in the names of the subjects for which we intend to make the plot. Note that the names of the subjects have to be the same as the names of the subjects passed in the original csv data file imported.
```{r, cache = TRUE}
subjects_considered <- c("subject1","subject2","subject3","subject4","subject5","subject117") # add the names of the subjects for which the plot is intended; if all subjects are being considered, pass in P.DATA$subject_names
freezing_plot <- gutbehaviour::accumulated_time_plot(freezing_cumu, experiment_time_in_sec = 15, subject_vec = subjects_considered) # change experiment_time_in_sec to 20 if the entire experiment takes 20 seconds
```

The following plot means that, for subject 3, at time = 10 seconds, the subject has already spent 0.25x15=3.75 seconds of time in freezing. The subject is not experiencing any freezing event during the time in which the slope is 0 (horizontal line). 
```{r, fig.width=7, fig.height=7, out.width="700px", out.height="700px"}
freezing_plot
```

# Heat map of proportion of time spent on each event 

At a fixed time t, for each subject S and each event E we are interested in the quantity "Amount of time spent in E before time t/Total time of experiment". We can compute and visualise this quantity using the following functions. 

```{r, cache=TRUE}
cumu <- gutbehaviour::generate_cumutime_all_events(master_cumulative_prof[[2]], P.DATA, master_cumulative_prof[[1]])
cumu_prof <- do.call(rbind, cumu)
```

The above step generates the cumulative time spent in each event for each subject at all considered time points. We can then generate a heat map with the following function. 

Specify the time point to consider in `time_to_consider` parameter in the function below.

Note that the parameter subject_vec requires us to specify the subjects for which the plot is intended. If this parameter is not specified, all subjects are shown. Set show_values to FALSE if one does not need to know the exact proportion of time spent.

```{r}
heat_map <- accumulated_time_heat_plot(cumu_prof, master_cumulative_prof = master_cumulative_prof, time_to_consider = 15, experiment_time_in_sec = 15, subject_vec = NULL, show_values = FALSE)
```

```{r, fig.width=7, fig.height=7, out.width="700px", out.height="700px"}
heat_map <- heat_map + scale_y_discrete(limits = paste("subject",1:121,sep="")) + theme(axis.text.y = element_blank(), axis.ticks = element_blank(),  axis.title.y.left = element_blank())
```

```{r}
cumu_prof_spread <- spread(cumu_prof, event_considered, cumu_time)
```

```{r}
ggplot(cumu_prof_spread %>% filter(time == master_cumulative_prof[[2]][150]), aes(x=freeze/15, y=flight/15, color=subjects)) + geom_point() + theme_classic()
```


